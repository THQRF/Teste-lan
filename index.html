<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>MooMoo P2P Ultra</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
body{margin:0;overflow:hidden;background:#b1cf67;font-family:Arial}
canvas{display:block}
#ui{position:absolute;top:10px;left:10px;color:#fff}
.btn{background:#e67e22;border:3px solid #2c3e50;
padding:6px;margin:2px;border-radius:8px;font-weight:bold}
#inventory{display:flex;gap:4px;margin-top:5px}
.slot{width:45px;height:45px;background:#555;
border:3px solid #222;color:white;font-size:12px}
</style>
</head>

<body>
<canvas id="c"></canvas>

<div id="ui">
<div>
üçé<span id="food">0</span>
üå≥<span id="wood">0</span>
ü™®<span id="stone">0</span><br>
‚ù§Ô∏è <span id="hp">100</span>
</div>

<button class="btn" onclick="craft('Espada')">Craft Espada</button>
<button class="btn" onclick="craft('Machado')">Craft Machado</button><br>

<button class="btn" onclick="exportSave()">Salvar Arquivo</button>
<button class="btn" onclick="document.getElementById('load').click()">Carregar</button>
<input type="file" id="load" hidden>

<div id="inventory"></div>
</div>

<script>
const canvas=c=document.getElementById("c")
const ctx=c.getContext("2d")

let peer,conn
let keys={}
let world=[]
let others={}

let inventory={
 slots:Array(6).fill(null),
 equipped:null
}

let p={
 id:null,name:"Player",
 x:2500,y:2500,
 hp:100,maxHp:100,
 wood:0,food:0,stone:0,
 weapon:{name:"M√£o",dmg:5,speed:1},
 angle:0
}

/* ===== WORLD ===== */
function generate(){
 world=[]
 const t=["tree","rock","bush"]
 for(let i=0;i<200;i++)
  world.push({
   x:Math.random()*5000,
   y:Math.random()*5000,
   s:30+Math.random()*10,
   type:t[Math.floor(Math.random()*3)]
  })
}
generate()

/* ===== INVENTORY ===== */
function updateInventory(){
 const inv=document.getElementById("inventory")
 inv.innerHTML=""
 inventory.slots.forEach((it,i)=>{
  let b=document.createElement("button")
  b.className="slot"
  b.innerText=it?it.name[0]:"-"
  b.onclick=()=>equip(i)
  inv.appendChild(b)
 })
}
updateInventory()

function equip(i){
 let it=inventory.slots[i]
 if(!it)return
 if(inventory.equipped?.id===it.id){
  inventory.equipped=null
  p.weapon={name:"M√£o",dmg:5,speed:1}
 }else{
  inventory.equipped=it
  p.weapon=it
 }
}

/* ===== CRAFT ===== */
function craft(type){
 let w=type=="Espada"?30:20
 let s=type=="Espada"?20:0
 if(p.wood<w||p.stone<s)return alert("Sem recursos")
 let slot=inventory.slots.findIndex(v=>v==null)
 if(slot==-1)return alert("Invent√°rio cheio")

 p.wood-=w;p.stone-=s

 let item={
  id:crypto.randomUUID(),
  name:type,
  dmg:(type=="Espada"?15:8)+Math.floor(Math.random()*10),
  speed:+(0.7+Math.random()).toFixed(2)
 }

 inventory.slots[slot]=item
 updateInventory()
 updateUI()
}

/* ===== SAVE FILE ===== */
function exportSave(){
 const data={p,inventory}
 const blob=new Blob([JSON.stringify(data,null,2)],{type:"text/plain"})
 const a=document.createElement("a")
 a.href=URL.createObjectURL(blob)
 a.download="moomoo_save.txt"
 a.click()
}

document.getElementById("load").onchange=e=>{
 const r=new FileReader()
 r.onload=()=>{
  let d=JSON.parse(r.result)
  p=d.p
  inventory=d.inventory
  updateInventory()
  updateUI()
 }
 r.readAsText(e.target.files[0])
}

/* ===== COLLISION ===== */
function hit(x,y,r,o){
 return Math.hypot(x-o.x,y-o.y)<r+o.s
}

function move(dx,dy){
 let nx=p.x+dx,ny=p.y+dy
 for(let o of world)
  if(hit(nx,ny,28,o))return
 p.x=nx;p.y=ny
}

/* ===== INPUT ===== */
onkeydown=e=>keys[e.key]=1
onkeyup=e=>keys[e.key]=0
onmousedown=attack
onmousemove=e=>{
 p.angle=Math.atan2(e.clientY-c.height/2,e.clientX-c.width/2)
}

/* ===== ATTACK ===== */
function attack(){
 world.forEach(o=>{
  if(Math.hypot(p.x-o.x,p.y-o.y)<90){
   let m=Math.ceil(p.weapon.dmg/5)
   if(o.type=="tree")p.wood+=5*m
   if(o.type=="rock")p.stone+=5*m
   if(o.type=="bush")p.food+=5*m
  }
 })
 updateUI()
}

/* ===== UI ===== */
function updateUI(){
 food.innerText=p.food
 wood.innerText=p.wood
 stone.innerText=p.stone
 hp.innerText=p.hp
}

/* ===== LOOP ===== */
function loop(){
 c.width=innerWidth;c.height=innerHeight
 ctx.save()
 ctx.translate(c.width/2-p.x,c.height/2-p.y)

 ctx.strokeStyle="#0002"
 for(let i=0;i<=5000;i+=100){
  ctx.beginPath();ctx.moveTo(i,0);ctx.lineTo(i,5000);ctx.stroke()
  ctx.beginPath();ctx.moveTo(0,i);ctx.lineTo(5000,i);ctx.stroke()
 }

 world.forEach(o=>{
  ctx.fillStyle=o.type=="tree"?"#5d9732":o.type=="rock"?"#7f8c8d":"#d35400"
  ctx.beginPath()
  o.type=="rock"
   ?ctx.rect(o.x-o.s,o.y-o.s,o.s*2,o.s*2)
   :ctx.arc(o.x,o.y,o.s,0,7)
  ctx.fill()
 })

 draw(p.x,p.y,true)
 ctx.restore()

 let sp=5
 if(keys.w)move(0,-sp)
 if(keys.s)move(0,sp)
 if(keys.a)move(-sp,0)
 if(keys.d)move(sp,0)

 requestAnimationFrame(loop)
}
loop()

function draw(x,y,me){
 ctx.save()
 ctx.translate(x,y)
 ctx.rotate(p.angle)
 ctx.fillStyle=me?"#d2b48c":"#e74c3c"
 ctx.beginPath();ctx.arc(0,0,28,0,7);ctx.fill()
 ctx.restore()
}

/* ===== P2P ===== */
peer=new Peer()
peer.on("open",id=>{
 p.id=id
 alert("Seu ID: "+id)
})
peer.on("connection",c=>{
 conn=c
 conn.on("data",d=>others[d.id]=d)
})
</script>
</body>
</html>
