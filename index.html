<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MooMoo P2P - Pro Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --border: #2c3e50; --green: #a2d058; --dark: #4e6e2a; --orange: #e67e22; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: #b1cf67; font-family: 'Arial Rounded MT Bold', Arial, sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; }
        #menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .card { background: var(--green); border: 6px solid var(--border); padding: 25px; border-radius: 30px; text-align: center; box-shadow: 0 10px 0 var(--dark); width: 340px; }
        input { padding: 12px; border: 3px solid var(--border); border-radius: 12px; margin: 8px 0; width: 85%; font-size: 16px; outline: none; }
        .btn { background: var(--orange); color: white; border: 3px solid var(--border); padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 95%; margin: 5px 0; box-shadow: 0 5px 0 #a35d1a; transition: 0.1s; font-size: 14px; }
        #ui { position: absolute; top: 15px; left: 15px; pointer-events: none; display: none; z-index: 5; }
        .hud { background: rgba(0,0,0,0.6); padding: 12px; border-radius: 15px; border: 3px solid white; color: white; margin-bottom: 10px; font-size: 16px;}
        #hotbar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: auto; z-index: 10; }
        .slot { width: 60px; height: 60px; background: rgba(0,0,0,0.6); border: 4px solid #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; color: white; }
        .slot.active { border-color: #f1c40f; background: rgba(241, 196, 15, 0.4); transform: scale(1.1); }
        #joy-container { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.2); border-radius: 50%; display: none; }
        #joy-stick { position: absolute; width: 50px; height: 50px; background: #fff; border-radius: 50%; top: 35px; left: 35px; opacity: 0.7; }
        #mobile-btns { position: absolute; bottom: 120px; right: 40px; display: none; }
        .m-btn { width: 75px; height: 75px; background: rgba(0,0,0,0.5); border: 4px solid white; border-radius: 50%; font-size: 30px; display: flex; align-items: center; justify-content: center; color: white; }
    </style>
</head>
<body>

    <div id="menu-overlay">
        <div class="card">
            <h1 style="color:white; -webkit-text-stroke: 1.5px var(--border);">MooMoo P2P</h1>
            <input type="text" id="nick" placeholder="NOME" maxlength="12">
            <button class="btn" onclick="start('host')">CRIAR SERVIDOR</button>
            <input type="text" id="targetId" placeholder="ID DO AMIGO">
            <button class="btn" style="background:#3498db; box-shadow:0 5px 0 #2980b9;" onclick="start('join')">ENTRAR</button>
        </div>
    </div>

    <div id="ui">
        <div class="hud">
            üçé <span id="food">0</span> | üå≥ <span id="wood">0</span> | ü™® <span id="stone">0</span><br>
            ‚ù§Ô∏è <span id="hp-text">100/100</span>
        </div>
        <button class="btn" style="width:100px; font-size:10px;" onclick="craft('Espada')">ESPADA (30W, 20S)</button>
        <button class="btn" style="width:100px; font-size:10px;" onclick="craft('Machado')">MACHADO (20W)</button>
    </div>

    <div id="hotbar">
        <div class="slot active" onclick="selectSlot(0)">üëä</div>
        <div class="slot" onclick="selectSlot(1)">ü™ì</div>
        <div class="slot" onclick="selectSlot(2)">‚öîÔ∏è</div>
        <div class="slot" onclick="selectSlot(3)">üçé</div>
    </div>

    <div id="joy-container"><div id="joy-stick"></div></div>
    <div id="mobile-btns"><div class="m-btn" onclick="attack()">‚öîÔ∏è</div></div>
    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let peer, conn, gameRunning = false;
    let world = [], entities = [], others = {}, attackAnim = 0, activeSlot = 0;
    let joyPos = { x: 0, y: 0 };

    const inventory = [
        { name: "M√£o", type: "weapon", dmg: 5, icon: "üëä" },
        { name: "Vazio", type: "empty", icon: "‚ùî" },
        { name: "Vazio", type: "empty", icon: "‚ùî" },
        { name: "Ma√ß√£", type: "food", icon: "üçé" }
    ];

    let p = { x: 2500, y: 2500, hp: 100, maxHp: 100, wood: 0, food: 0, stone: 0, weapon: inventory[0], angle: 0, name: "" };

    function selectSlot(i) {
        if (inventory[i].type === "empty") return;
        activeSlot = i; p.weapon = inventory[i];
        document.querySelectorAll('.slot').forEach((s, idx) => s.classList.toggle('active', idx === i));
    }

    function craft(type) {
        let wC = type === 'Espada' ? 30 : 20;
        let sC = type === 'Espada' ? 20 : 0;
        if (p.wood >= wC && p.stone >= sC) {
            p.wood -= wC; p.stone -= sC;
            let item = { name: type, type: "weapon", dmg: type === 'Espada' ? 15 : 10 };
            inventory[type === 'Espada' ? 2 : 1] = item;
            updateUI();
        }
    }

    function attack() {
        if (attackAnim > 0) return;
        attackAnim = Math.PI;
        if (p.weapon.type === "food") {
            if (p.food >= 10 && p.hp < p.maxHp) {
                p.food -= 10; p.hp = Math.min(p.maxHp, p.hp + 20);
            }
        } else {
            world.forEach(obj => {
                if (Math.hypot(p.x - obj.x, p.y - obj.y) < obj.s + 40) {
                    if (obj.type === 'tree') p.wood += 5;
                    if (obj.type === 'rock') p.stone += 5;
                    if (obj.type === 'bush') p.food += 5;
                }
            });
            entities.forEach(en => {
                if (Math.hypot(p.x - en.x, p.y - en.y) < 60) en.hp -= p.weapon.dmg;
            });
        }
        updateUI();
    }

    function update() {
        let oldX = p.x, oldY = p.y;
        const speed = 5;
        if (keys['w']) p.y -= speed; if (keys['s']) p.y += speed;
        if (keys['a']) p.x -= speed; if (keys['d']) p.x += speed;
        p.x += joyPos.x * speed; p.y += joyPos.y * speed;

        // Colis√£o com Recursos
        world.forEach(obj => {
            if (Math.hypot(p.x - obj.x, p.y - obj.y) < obj.s + 25) { p.x = oldX; p.y = oldY; }
        });

        // IA Animais
        entities = entities.filter(en => en.hp > 0);
        entities.forEach(en => {
            let dist = Math.hypot(p.x - en.x, p.y - en.y);
            if (en.type === 'wolf' && dist < 300) {
                en.angle = Math.atan2(p.y - en.y, p.x - en.x);
                en.x += Math.cos(en.angle) * 3; en.y += Math.sin(en.angle) * 3;
                if (dist < 50) { p.hp -= 0.2; updateUI(); }
            } else {
                if (Math.random() > 0.98) en.angle = Math.random() * Math.PI * 2;
                en.x += Math.cos(en.angle) * 1; en.y += Math.sin(en.angle) * 1;
            }
            en.x = Math.max(0, Math.min(5000, en.x)); en.y = Math.max(0, Math.min(5000, en.y));
        });

        if (attackAnim > 0) attackAnim -= 0.2;
        if (p.hp <= 0) { alert("Voc√™ morreu!"); location.reload(); }
    }

    function drawPlayer(x, y, ang, name, hp, anim, weaponName) {
        ctx.save();
        ctx.translate(x, y);
        // Barra de Vida
        ctx.fillStyle = "#db3d3d"; ctx.fillRect(-30, -50, 60, 8);
        ctx.fillStyle = "#52e352"; ctx.fillRect(-30, -50, 60 * (hp/100), 8);
        
        ctx.rotate(ang);
        // Bra√ßos/Arma
        let handOff = Math.sin(anim) * 20;
        ctx.save();
        ctx.rotate(anim > 0 ? 0.4 : 0);
        if (weaponName === "Espada") {
            ctx.fillStyle = "#bdc3c7"; ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 2;
            ctx.fillRect(25 + handOff, -5, 45, 12); ctx.strokeRect(25 + handOff, -5, 45, 12);
        } else if (weaponName === "Machado") {
            ctx.fillStyle = "#7f8c8d"; ctx.fillRect(45 + handOff, -15, 15, 30);
            ctx.fillStyle = "#95a5a6"; ctx.fillRect(30 + handOff, -5, 20, 10);
        } else if (weaponName === "Ma√ß√£") {
            ctx.fillStyle = "#ff4d4d"; ctx.beginPath(); ctx.arc(40 + handOff, 0, 12, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();

        // M√£os
        ctx.fillStyle = "#d2b48c"; ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(25 + handOff, -20, 9, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.beginPath(); ctx.arc(25 + handOff, 20, 9, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        // Corpo
        ctx.fillStyle = "#d2b48c"; ctx.beginPath(); ctx.arc(0, 0, 28, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.restore();
    }

    function render() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        ctx.save();
        ctx.translate(canvas.width/2 - p.x, canvas.height/2 - p.y);
        
        // Ch√£o e Grade
        ctx.fillStyle = "#b1cf67"; ctx.fillRect(0,0,5000,5000);
        ctx.strokeStyle = "rgba(0,0,0,0.05)";
        for(let i=0; i<=5000; i+=100) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i, 5000); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(5000, i); ctx.stroke(); }

        // Recursos
        world.forEach(obj => {
            ctx.save(); ctx.translate(obj.x, obj.y);
            if(obj.type === 'tree') {
                ctx.fillStyle = "#5d9732"; ctx.beginPath(); ctx.arc(0,0,obj.s,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = "#a2d058"; ctx.beginPath(); ctx.arc(0,0,obj.s*0.6,0,Math.PI*2); ctx.fill();
            } else if(obj.type === 'rock') {
                ctx.fillStyle = "#7f8c8d"; ctx.beginPath(); ctx.arc(0,0,obj.s,0,Math.PI*2); ctx.fill();
            } else if(obj.type === 'bush') {
                ctx.fillStyle = "#27ae60"; ctx.beginPath(); ctx.arc(0,0,obj.s,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = "#ff4d4d"; for(let j=0; j<3; j++) { ctx.beginPath(); ctx.arc(Math.cos(j*2)*15, Math.sin(j*2)*15, 6, 0, Math.PI*2); ctx.fill(); }
            }
            ctx.restore();
        });

        entities.forEach(en => {
            ctx.save(); ctx.translate(en.x, en.y); ctx.rotate(en.angle);
            ctx.font = "40px Arial"; ctx.fillText(en.type === 'cow' ? "üêÑ" : "üê∫", -20, 15);
            ctx.restore();
        });

        for(let id in others) drawPlayer(others[id].x, others[id].y, others[id].angle, others[id].name, others[id].hp, others[id].anim, others[id].weapon);
        drawPlayer(p.x, p.y, p.angle, p.name, p.hp, attackAnim, p.weapon.name);
        
        ctx.restore();
        if(gameRunning) { update(); requestAnimationFrame(render); }
    }

    const keys = {};
    window.onkeydown = e => keys[e.key.toLowerCase()] = true;
    window.onkeyup = e => keys[e.key.toLowerCase()] = false;
    window.onmousemove = e => { p.angle = Math.atan2(e.clientY - canvas.height/2, e.clientX - canvas.width/2); };
    window.onmousedown = () => attack();

    function start(mode) {
        p.name = document.getElementById('nick').value || "Player";
        document.getElementById('menu-overlay').style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        if ('ontouchstart' in window) { document.getElementById('joy-container').style.display = 'block'; document.getElementById('mobile-btns').style.display = 'block'; setupMobile(); }
        generateWorld(); gameRunning = true; render();
    }

    function generateWorld() {
        for(let i=0; i<100; i++) world.push({ x: Math.random()*5000, y: Math.random()*5000, type: ['tree','rock','bush'][Math.floor(Math.random()*3)], s: 35+Math.random()*15 });
        for(let i=0; i<20; i++) entities.push({ x: Math.random()*5000, y: Math.random()*5000, type: Math.random()>0.5?'cow':'wolf', hp: 50, angle: 0 });
    }

    function updateUI() {
        document.getElementById('food').innerText = p.food;
        document.getElementById('wood').innerText = p.wood;
        document.getElementById('stone').innerText = p.stone;
        document.getElementById('hp-text').innerText = `${Math.floor(p.hp)}/100`;
    }

    function setupMobile() {
        const joy = document.getElementById('joy-container');
        const stick = document.getElementById('joy-stick');
        joy.addEventListener('touchmove', e => {
            const rect = joy.getBoundingClientRect();
            const touch = e.touches[0];
            const dx = touch.clientX - (rect.left + 60), dy = touch.clientY - (rect.top + 60);
            const dist = Math.min(Math.hypot(dx, dy), 50), angle = Math.atan2(dy, dx);
            joyPos = { x: Math.cos(angle)*(dist/50), y: Math.sin(angle)*(dist/50) };
            p.angle = angle; stick.style.transform = `translate(${joyPos.x*40}px, ${joyPos.y*40}px)`;
        });
        joy.addEventListener('touchend', () => { joyPos = {x:0,y:0}; stick.style.transform = 'translate(0,0)'; });
    }
</script>
</body>
</html>
