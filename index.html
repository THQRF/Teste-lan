<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MooMoo P2P - Deluxe Edition</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --green: #a2d058; --dark-green: #4e6e2a; --orange: #e67e22; --border: #2c3e50; }
        body, html { margin: 0; padding: 0; overflow: hidden; background: var(--green); font-family: 'Arial Rounded MT Bold', Arial; }
        
        /* Menu Estilizado */
        #menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .card { background: var(--green); border: 6px solid var(--border); padding: 30px; border-radius: 30px; text-align: center; box-shadow: 0 10px 0 var(--dark-green); }
        input { padding: 12px; border: 3px solid var(--border); border-radius: 10px; margin: 10px 0; font-size: 16px; width: 250px; }
        .btn-ui { padding: 12px 24px; border: 3px solid var(--border); border-radius: 10px; background: var(--orange); color: white; cursor: pointer; font-weight: bold; margin: 5px; box-shadow: 0 5px 0 #a35d1a; }
        .btn-ui:active { transform: translateY(3px); box-shadow: 0 2px 0 #a35d1a; }

        /* UI de Jogo */
        #game-ui { position: absolute; top: 20px; left: 20px; pointer-events: none; display: none; }
        .stat-bar { background: rgba(0,0,0,0.6); padding: 10px; border-radius: 15px; color: white; border: 2px solid #fff; margin-bottom: 5px; }
        
        #minimap { position: absolute; bottom: 20px; right: 20px; width: 160px; height: 160px; background: var(--green); border: 5px solid white; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
        
        #mobile-controls { position: absolute; bottom: 20px; right: 200px; display: none; }
        .btn-mobile { width: 70px; height: 70px; background: rgba(255,255,255,0.4); border: 3px solid white; border-radius: 50%; margin: 5px; pointer-events: auto; font-size: 24px; color: white; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="menu-overlay">
        <div class="card">
            <h1 style="color:white; -webkit-text-stroke: 2px var(--border); font-size: 40px;">MooMoo P2P</h1>
            <input type="text" id="nickInput" placeholder="NOME DO HER√ìI...">
            <br>
            <button class="btn-ui" onclick="initGame('host')">CRIAR SERVIDOR</button>
            <br>
            <input type="text" id="targetId" placeholder="ID DO AMIGO...">
            <br>
            <button class="btn-ui" onclick="initGame('join')">ENTRAR NO SERVER</button>
            <hr border="0">
            <button class="btn-ui" style="background:#27ae60" onclick="document.getElementById('fileIn').click()">CARREGAR SAVE (.TXT)</button>
        </div>
    </div>

    <div id="game-ui">
        <div class="stat-bar">üçé Comida: <span id="res-f">0</span> | üå≥ Madeira: <span id="res-w">0</span> | ü™® Pedra: <span id="res-s">0</span></div>
        <div class="stat-bar">‚≠ê Level: <span id="lvl">1</span> | ‚öîÔ∏è <span id="weaponName">M√£o</span></div>
    </div>

    <div id="minimap"><canvas id="minimapCanvas" width="160" height="160"></canvas></div>

    <div id="mobile-controls">
        <div class="btn-mobile" onmousedown="handleAttack()">‚öîÔ∏è</div>
        <div class="btn-mobile" onmousedown="heal()">üçé</div>
    </div>

    <input type="file" id="fileIn" style="display:none" onchange="loadGame(event)">
    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const mCanvas = document.getElementById('minimapCanvas');
    const mCtx = mCanvas.getContext('2d');

    let p = { 
        name: "Player", x: 2500, y: 2500, hp: 100, maxHp: 100, 
        wood: 0, food: 0, stone: 0, lvl: 1, 
        weapon: { name: "M√£o", dmg: 5 }, angle: 0 
    };

    let worldItems = [];
    const worldSize = 5000;

    function generateProcedural() {
        for(let i=0; i<200; i++) {
            worldItems.push({
                x: Math.random() * worldSize,
                y: Math.random() * worldSize,
                type: ['tree', 'rock', 'bush'][Math.floor(Math.random()*3)],
                size: 30 + Math.random() * 20
            });
        }
    }

    // --- GR√ÅFICOS DESENHADOS (ESTILO CARTOON) ---
    function drawTree(x, y, size) {
        ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 4;
        ctx.fillStyle = "#3e6521"; // Tronco
        ctx.beginPath(); ctx.rect(x-size/4, y, size/2, size); ctx.fill(); ctx.stroke();
        ctx.fillStyle = "#5d9732"; // Folhas
        ctx.beginPath(); ctx.arc(x, y-size/2, size, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    }

    function drawRock(x, y, size) {
        ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 4;
        ctx.fillStyle = "#7f8c8d";
        ctx.beginPath(); ctx.roundRect(x-size, y-size, size*2, size*2, 10); ctx.fill(); ctx.stroke();
    }

    function drawPlayer(x, y, angle, isMe) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(angle);
        
        // M√£os
        ctx.fillStyle = "#d2b48c"; ctx.strokeStyle = "#2c3e50"; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(40, -15, 12, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        ctx.beginPath(); ctx.arc(40, 15, 12, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        
        // Corpo
        ctx.fillStyle = isMe ? "#d2b48c" : "#e74c3c";
        ctx.beginPath(); ctx.arc(0, 0, 30, 0, Math.PI*2); ctx.fill(); ctx.stroke();
        
        ctx.restore();
    }

    // --- SISTEMA DE SAVE/LOAD TXT ---
    function saveGame() {
        const data = `NAME:${p.name}|W:${p.wood}|S:${p.stone}|F:${p.food}|LVL:${p.lvl}|HP:${p.hp}|X:${p.x}|Y:${p.y}|WPN:${p.weapon.name}|DMG:${p.weapon.dmg}`;
        const blob = new Blob([data], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `moomoo_save.txt`;
        a.click();
    }

    function loadGame(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const parts = ev.target.result.split('|');
            parts.forEach(part => {
                const [key, val] = part.split(':');
                if(key === 'W') p.wood = parseInt(val);
                if(key === 'S') p.stone = parseInt(val);
                if(key === 'LVL') p.lvl = parseInt(val);
                if(key === 'WPN') p.weapon.name = val;
            });
            alert("Personagem Carregado!");
            initGame('host');
        };
        reader.readAsText(e.target.files[0]);
    }

    // --- GAME LOOP ---
    const keys = {};
    window.onkeydown = e => { 
        keys[e.key.toLowerCase()] = true; 
        if(e.key === 'q') heal();
        if(e.key === 'p') saveGame();
    };
    window.onkeyup = e => keys[e.key.toLowerCase()] = false;

    function update() {
        if(keys['w']) p.y -= 5; if(keys['s']) p.y += 5;
        if(keys['a']) p.x -= 5; if(keys['d']) p.x += 5;
        
        // Minimapa
        mCtx.fillStyle = "#a2d058"; mCtx.fillRect(0,0,160,160);
        mCtx.fillStyle = "white";
        mCtx.fillRect((p.x/worldSize)*160, (p.y/worldSize)*160, 4, 4);
    }

    function render() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        ctx.fillStyle = "#b1cf67"; ctx.fillRect(0,0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2 - p.x, canvas.height/2 - p.y);

        // Desenhar Ch√£o (Grid)
        ctx.strokeStyle = "rgba(0,0,0,0.05)";
        for(let i=0; i<worldSize; i+=100) {
            ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, worldSize); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(worldSize, i); ctx.stroke();
        }

        worldItems.forEach(item => {
            if(item.type === 'tree') drawTree(item.x, item.y, item.size);
            else if(item.type === 'rock') drawRock(item.x, item.y, item.size);
            else {
                ctx.fillStyle = "#d35400"; ctx.beginPath(); ctx.arc(item.x, item.y, 15, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            }
        });

        drawPlayer(p.x, p.y, p.angle, true);
        ctx.restore();

        update();
        requestAnimationFrame(render);
    }

    function initGame(mode) {
        document.getElementById('menu-overlay').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        if('ontouchstart' in window) document.getElementById('mobile-controls').style.display = 'block';
        p.name = document.getElementById('nickInput').value || "Player";
        generateProcedural();
        render();
    }

    // Sincroniza√ß√£o de Mouse para √Çngulo
    window.onmousemove = e => {
        p.angle = Math.atan2(e.clientY - canvas.height/2, e.clientX - canvas.width/2);
    };

    function heal() { if(p.food >= 10) { p.food -= 10; p.hp = Math.min(p.maxHp, p.hp+20); updateUI(); } }
    function updateUI() {
        document.getElementById('res-f').innerText = p.food;
        document.getElementById('res-w').innerText = p.wood;
        document.getElementById('res-s').innerText = p.stone;
    }
</script>
</body>
</html>
